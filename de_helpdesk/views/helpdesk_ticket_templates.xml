<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_layout" name="Portal layout: ticket menu entry" inherit_id="portal.portal_breadcrumbs"
              priority="50">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'ticket' or ticket"
                t-attf-class="breadcrumb-item #{'active ' if not ticket else ''}">
                <a t-if="ticket" t-attf-href="/my/tickets?{{ keep_query() }}">Tickets</a>
                <t t-else="">Tickets</t>
            </li>
            <li t-if="ticket" class="breadcrumb-item active">
                <t t-esc="ticket.name"/>
            </li>
        </xpath>
    </template>
    <template id="portal_my_home" name="Portal My Home : ticket entries" inherit_id="portal.portal_my_home"
              priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="ticket_count" t-call="portal.portal_docs_entry">
                <t t-set="title">Tickets</t>
                <t t-set="url" t-value="'/my/tickets'"/>
                <t t-set="count" t-value="ticket_count"/>
            </t>
            <form method="POST" t-attf-action="/new/ticket">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <button name="create_new_ticket" type="action" class="btn btn-primary" groups="base.group_portal"
                        style="float: right; margin-right: 0px; margin-top:5px;">Nouvelle ticket
                </button>
            </form>
        </xpath>
    </template>

    <template id="portal_my_tickets" name="My tickets">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <form method="POST" t-attf-action="/new/ticket">
                <h3>Tickets
                    <t t-call="portal.portal_searchbar"/>
                    <button name="create_new_ticket" type="action" class="btn btn-primary" groups="base.group_portal"
                            style="float: right; margin-right: 5px;">Nouvelle ticket
                    </button>
                </h3>
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            </form>
            <t t-if="not tickets">
                <p>There are no tickets in your account.</p>
            </t>
            <div t-if="tickets" class="panel panel-default">
                <div class="table-responsive">
                    <table class="table table-hover o_portal_my_doc_table">
                        <thead>
                            <tr class="active">
                                <th>Ticket #</th>
                                <th>Nom</th>
                                <th>Catégorie</th>
                                <th>État</th>
                                <th>Date de création</th>
                                <th>mise à jour</th>
                                <th>Date fermeture</th>
                            </tr>
                        </thead>
                        <t t-foreach="tickets" t-as="ticket">
                            <tr>
                                <td>
                                    <a t-attf-href="/my/ticket/#{ticket.id}">
                                        <t t-esc="ticket.number"/>
                                    </a>
                                </td>
                                <td>
                                    <a t-attf-href="/my/ticket/#{ticket.id}">
                                        <t t-esc="ticket.name"/>
                                    </a>
                                </td>
                                <td>
                                    <t t-esc="ticket.category_id.name"/>
                                </td>
                                <td>
                                    <t t-esc="ticket.stage_id.name"/>
                                </td>
                                <td>
                                    <span t-field="ticket.create_date"/>
                                </td>
                                <td>
                                    <span t-field="ticket.last_stage_update"/>
                                </td>
                                <td>
                                    <span t-field="ticket.closed_date"/>
                                </td>
                            </tr>
                        </t>
                    </table>
                </div>
                <div t-if="pager" class="o_portal_pager text-center">
                    <t t-call="portal.pager"/>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_helpdesk_ticket_page" name="Ticket Portal Template">
        <t t-call="portal.portal_layout">
            <div class="card mt-0 border-top-0 rounded-0 rounded-bottom">
                <div class="card-header">
                    <div class="row no-gutters">
                        <div class="col-md">
                            <h5>
                                <t t-call='portal.record_pager'/>
                                <span t-field="ticket.name"/>
                            </h5>
                        </div>
                        <div class="col-md text-md-right">
                            <small class="text-right">Status:</small>
                            <span t-field="ticket.stage_id.name" class=" badge badge-pill badge-info"
                                  title="Current stage of this ticket"/>
                        </div>
                        <!--                            <t t-foreach="closed_stages" t-as="stage">-->
                        <!--                                <form method="GET" t-if="not ticket.closed_date" t-attf-action="/ticket/close" style="display:inline;">-->
                        <!--                                    <input type="hidden" name="ticket_id" t-attf-value="#{ticket.id}"/>-->
                        <!--                                    <input type="hidden" name="stage_id" t-attf-value="#{stage.id}"/>-->
                        <!--                                    <button type="submit" class="btn btn-success pull-right" style="margin-right:15px;margin-top:3px;"><span t-field="stage.name"/></button>-->
                        <!--                                </form>-->
                        <!--                            </t>-->
                    </div>
                </div>
            </div>
            <div class="container bg-white no-gutters border rounded" style="background-image:url('/de_helpdesk/static/src/img/ticket.png');background-size: 100% 100%;background-repeat: no-repeat;">
                <div class="row card-body mb8">
                    <div class="col-md-6 mb-0" style="padding-left: 17%;">
                        <p>
                            <strong>Reporté le:</strong>
                            <span t-field="ticket.create_date"/>
                        </p>
                        <p class="oe_inline">
                            <strong>Reporté par:</strong>
                            <img t-if="ticket.partner_id.image_1024" class="rounded-circle o_portal_contact_img"
                                 t-attf-src="data:image/png;base64,#{ticket.partner_id.image_1024}" alt="Contact"/>
                            <img t-else="" class="rounded-circle o_portal_contact_img"
                                 src="/web/static/src/img/user_menu_avatar.png" alt="Contact"/>
                            <span t-field="ticket.partner_id.name"/>
                            <br/> (
                           <span t-field="ticket.partner_id.email"/> )
                        </p>
                        <p>
                            <strong>Catégorie:</strong>
                            <span t-field="ticket.category_id.name"/>
                        </p>
                        <p>
                            <strong>Canal:</strong>
                            <span t-field="ticket.channel_id.name"/>
                        </p>
                    </div>
                    <div class="col-md-6 mb-0" style="padding-left: 17%;padding-right: 17%">
                        <p>
                            <strong>Mise à jour:</strong>
                            <span t-field="ticket.last_stage_update"/>
                        </p>
                        <p>
                            <strong>Gérer par:</strong>
                            <span t-field="ticket.team_id.name"/>
                        </p>
                    </div>
                    <div class="col-md-12 mb-0 description" style="padding-left: 17%;" t-if="ticket.pole_emploi==False">
                        <p>
                            <strong>Déscription</strong>
                            <t t-raw="ticket.description"/>
                        </p>
                    </div>
                </div>

            </div>


            <div class="o_portal_messages_container mt32">
                <h4>Historique des messages et communication</h4>
                <t t-call="portal.message_thread">
                    <t t-set="object" t-value="ticket"/>
                </t>
            </div>

            <div class="oe_structure mb32"/>

        </t>
    </template>
    <template id="portal_create_ticket" name="Create Ticket">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="text-center" t-if="pm=='pole_emploi'">Créer une nouvelle Demande</h1>
                        <h1 class="text-center" t-if="pm!='pole_emploi'">Contactez-nous</h1>
                    </div>
                </div>
            </div>

            <form action="/submitted/ticket" method="POST" class="form-horizontal mt32" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="name">Nom</label>
                    <div class="col-md-7 col-sm-8">
                        <input type="text" class="form-control" name="name" t-attf-value="#{name}" required="True"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="email">Email</label>
                    <div class="col-md-7 col-sm-8">
                        <input t-if="request.website.is_public_user()==False" type="email" class="form-control"
                               name="email" required="True" t-attf-value="#{email}"
                               readonly="True"/>
                    </div>
                    <div class="col-md-7 col-sm-8">
                        <input t-if="request.website.is_public_user()==True" type="email" class="form-control"
                               name="email" required="True" t-attf-value="#{email}"/>
                    </div>
                </div>
                <div class="form-group" t-if="pm=='pole_emploi'">
                    <label class="col-md-3 col-sm-4 control-label" for="name">Identifiant pôle-emploi</label>
                    <div class="col-md-7 col-sm-8">
                        <input type="text" class="form-control" name="emploi_id" required="True"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="category">Catégorie</label>
                    <div class="col-md-7 col-sm-8">
                        <select t-if="pm!='pole_emploi'" class="form-control" id="ticket_category" name="category"
                                required="True">
                            <t t-foreach="categories" t-as="cat">
                                <option t-attf-value="#{cat.id}" t-attf-id="pm_{{cat.code}}">
                                    <t t-esc="cat.name"/>
                                </option>
                            </t>
                        </select>
                        <select t-if="pm=='pole_emploi'" class="form-control" id="ticket_category" name="category"
                                required="True" readonly="True">
                            <t t-foreach="categories" t-as="cat">
                                <t t-if="cat.code=='client'">
                                    <option t-attf-value="#{cat.id}" t-attf-id="pm_{{cat.code}}" selected="selected">
                                        <t t-esc="cat.name"/>
                                    </option>
                                </t>
                            </t>
                        </select>

                    </div>
                </div>
                <div class="form-group" t-if="pm!='pole_emploi'">
                    <label class="col-md-3 col-sm-4 control-label" for="subject">Sujet</label>
                    <div class="col-md-7 col-sm-8">
                        <input type="text" class="form-control" id="ticket_subject" name="subject" required="True"/>
                    </div>
                </div>
                <div class="form-group" t-if="pm=='pole_emploi'">
                    <label class="col-md-3 col-sm-4 control-label" for="subject">Sujet</label>
                    <div class="col-md-7 col-sm-8">
                        <select t-if="pm=='pole_emploi'" class="form-control" id="ticket_subject" name="subject"
                                required="True">
                            <option t-attf-value="Devis Pôle-emploi(Kairos)" t-attf-id="subject_pole_emploi" >
                                Devis Pôle-emploi (Kairos)
                            </option>
                            <option t-attf-value="Devis Région Haut-De-France(CHPF)" t-attf-id="subject_region" >
                                Devis Région Haut-De-France (CHPF)
                            </option>

                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="attachment">Fichier supplémentaire</label>
                    <div class="col-md-7 col-sm-8">
                        <div class="btn btn-default btn-file col-md-12">
                            <input class="form-control o_website_form_input" name="attachment" id="attachment"
                                   type="file" multiple="multiple"/>
                        </div>
                    </div>
                </div>
                <div class="form-group" t-if="pm!='pole_emploi'">
                    <label class="col-md-3 col-dm-4 control-label" for="description">Déscription</label>
                    <div class="col-md-7 col-sm-8">
                        <textarea class="form-control" name="description" style="min-height: 120px"
                                  required="False"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-offset-3 col-sm-offset-4 col-sm-8 col-md-7">
                        <button class="btn btn-primary btn-lg">Créer une demande</button>
                    </div>
                </div>
            </form>
        </t>
    </template>

    <template id="success_ticket" name="Ticket Received">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container" style="background-image:url('/de_helpdesk/static/src/img/ticket.png');background-size: 100% 100%;background-repeat: no-repeat;">
                    <div clas="row">
                        <t t-if="request.session.get('form_builder_model_model', '') == 'helpdesk.ticket'">
                            <t t-set="ticket" t-value="request.website._website_form_last_record().sudo()"/>
                        </t>
                        <h3 class="text-center">
                            <i class="fa fa-check-circle fa-2x text-success" role="img" aria-label="Success"
                               title="Success"/>
                        </h3>
                        <h3 class="text-center">Votre Demande a été reçu avec succès</h3>
                        <h3 class="text-center">Merci d'avoir ouvert une Demande, notre équipe la prendra en charge dans
                            les plus bref délais.
                        </h3>
                    </div>
                </div>
            </div>
        </t>
    </template>

</odoo>
